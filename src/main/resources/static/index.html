<!DOCTYPE html>
<html>
	<head>
		<meta http-equiv="content-type" content="text/html;charset=utf-8">
		<title>看板</title>
		<link href="/webjars/bootstrap/css/bootstrap.min.css" rel="stylesheet">
		<script src="/webjars/jquery/jquery.min.js"></script>
		<script src="/webjars/sockjs-client/sockjs.min.js"></script>
		<script src="/webjars/stomp-websocket/stomp.min.js"></script>
		<script src="/echarts.min.js"></script>
		<style>
			body {
				background-color: #061325;
			}
		
			.panel-primary>.panel-heading {
				color: #70cac7;
				background-color: #06131b;
			}
		
			.panel-primary>.panel-body {
				background-color: #001531;
			}
		</style>
	</head>
	<body>
		<div class="container">
			<div class="row">
				<div class="col-md-6">
					<div class="panel panel-primary">
						<div class="panel-heading">
							内存使用率
						</div>
						<div class="panel-body">
							<div id="mu-pie-chart" style="height: 300px;"></div>
						</div>
					</div>
				</div>
				<div class="col-md-6">
					<div class="panel panel-primary">
						<div class="panel-heading">
							内存使用率变化
						</div>
						<div class="panel-body">
							<div id="mu-line-chart" style="height: 300px;"></div>
						</div>
					</div>
				</div>
			</div>
			<div class="row">
				<div class="col-md-6">
					<div class="panel panel-primary">
						<div class="panel-heading">
							CPU使用率
						</div>
						<div class="panel-body">
							<div id="cpu-pie-chart" style="height: 300px;"></div>
						</div>
					</div>
				</div>
				<div class="col-md-6">
					<div class="panel panel-primary">
						<div class="panel-heading">
							CPU使用率变化
						</div>
						<div class="panel-body">
							<div id="cpu-line-chart" style="height: 300px;"></div>
						</div>
					</div>
				</div>
			</div>
			<div class="row">
				<div class="col-md-6">
					<div class="panel panel-primary">
						<div class="panel-heading">
							网络数据接收速度
						</div>
						<div class="panel-body">
							<div id="netrx-line-chart" style="height: 300px;"></div>
						</div>
					</div>
				</div>
				<div class="col-md-6">
					<div class="panel panel-primary">
						<div class="panel-heading">
							网络数据发送速度
						</div>
						<div class="panel-body">
							<div id="nettx-line-chart" style="height: 300px;"></div>
						</div>
					</div>
				</div>
			</div>
			<div class="row">
				<div class="col-md-6">
					<div class="panel panel-primary">
						<div class="panel-heading">
							磁盘读速度
						</div>
						<div class="panel-body">
							<div id="diskr-line-chart" style="height: 300px;"></div>
						</div>
					</div>
				</div>
				<div class="col-md-6">
					<div class="panel panel-primary">
						<div class="panel-heading">
							磁盘写速度
						</div>
						<div class="panel-body">
							<div id="diskw-line-chart" style="height: 300px;"></div>
						</div>
					</div>
				</div>
			</div>
		</div>
		<div style="position: fixed; top: 100px; display: none; text-align: center;" id="error-message" class="alert alert-danger">
			服务器连接错误
		</div>
		<script>

var LINECHART_MAX = 100;
var COLOR_ORDER = ['#963c3e','#3b5579', '#4e9845', '#ab9f52', '#729e8a','#749f83',  '#ca8622', '#bda29a','#6e7074', '#546570', '#c4ccd3'];
var UtilizationPie = function(id, name, labels) {
	var chart = echarts.init(document.getElementById(id)),
		data = [
			{value: 0, name: labels.used},
			{value: 1, name: labels.free}
		],
		option = {
			color: COLOR_ORDER,
			legend: {
				textStyle: {
					color: '#a5c8e6'
				},
				data: [labels.used, labels.free]
			},
			series: [
				{
					name: name,
					type: 'pie',
					label: {
						show: true,
						formatter: '{b}: {d} %'
					},
					itemStyle: {
						opacity: 0.9
					},
					data: data
				}
			]
		};
	// init
	chart.setOption(option);
	return {
		update: function(used, free) {
			data[0].value = used;
			data[1].value = free;
			chart.setOption({
				series: [{data: data}]
			});
		}
	};
};
var memoryUsagePie = UtilizationPie('mu-pie-chart', '内存使用率', {
	used: '已用',
	free: '可用'
});
var cpuUsagePie = UtilizationPie('cpu-pie-chart', 'CPU使用率', {
	used: '已用',
	free: '空闲'
});


function sizeFormatter(value) {
	var s = value;
	if (s < 1000) return s + '';
	s /= 1024;
	if (s < 1000) return s.toFixed(1) + ' Kb';
	s /= 1024;
	if (s < 1000) return s.toFixed(1) + ' Mb';
	s /= 1024;
	return s.toFixed(1) + ' Gb';
}

var TimeLine = function(id, labels, formatter) {
	var chart = echarts.init(document.getElementById(id)),
		xData = [],
		yData = [],
		legends = [],
		option = {
			color: COLOR_ORDER,
			legend: {
				textStyle: {
					color: '#a5c8e6'
				},
				data: legends
			},
			tooltip: {
				trigger: 'axis',
				formatter: function(params) {
					var t = '';
					if (typeof(formatter) == 'function') {
						for (var i = 0; i < params.length; i++) {
							t += params[i].seriesName + ': ' +
								formatter(params[i].value) + '<br>\n';
						}
					} else {
						for (var i = 0; i < params.length; i++) {
							t += params[i].seriesName + ': ' +
								params[i].value + '<br>\n';
						}
					}
					return t;
				}
			},
			xAxis: [
				{
					type: 'category',
					axisLine: {
						lineStyle: {
							color: '#a5c8e6'
						}
					},
					data: xData
				}
			],
			yAxis: [
				{
					type: 'value',
					axisLine: {
						lineStyle: {
							color: '#a5c8e6'
						}
					},
					axisLabel: {
						formatter: formatter
					}
				}
			],
			serise: yData
		};
	// init
	chart.setOption(option);
	return {
		update: function(data) {
			if (xData.length >= LINECHART_MAX)
				xData.shift();
			xData.push(new Date().toLocaleTimeString());

			for (var key in data) {
				var legend = key in labels ? labels[key] : key;
				if (legends.indexOf(legend) == -1) {
					legends.push(legend);
					yData.push({
						name: legend,
						type: 'line',
						itemStyle: {normal: {areaStyle: {type: 'default'}}},
						data: [data[key]]
					});
				} else {
					for (var i = 0; i < yData.length; i++) {
						if (yData[i].name == legend) {
							if (yData[i].data.length >= LINECHART_MAX)
								yData[i].data.shift();
							yData[i].data.push(data[key]);
							break;
						}
					}
				}
			}

			chart.setOption({
				legend: {data: legends},
				xAxis: [{data: xData}],
				series: yData
			});
		}
	};
};

var memoryUsageLine = TimeLine('mu-line-chart', {
	utilization: '内存使用率'
}, '{value} %');

var cpuUsageLine = TimeLine('cpu-line-chart', {}, '{value} %');

var netRxLine = TimeLine('netrx-line-chart', {}, sizeFormatter);
var netTxLine = TimeLine('nettx-line-chart', {}, sizeFormatter);
var diskRLine = TimeLine('diskr-line-chart', {}, sizeFormatter);
var diskWLine = TimeLine('diskw-line-chart', {}, sizeFormatter);
var ws = null;

function connect() {
	if (window.WebSocket) {
		ws = new WebSocket('ws://localhost:8080/websocket');
	} else {
		ws = new SockJS('/sockjs');
	}
	ws.onmessage = function (evt) {
		var arr = evt.data.split(':');
		if (arr.length) {
			if (arr[0] == 'cpu') {
				var cpus = arr[1].split(',');
				var data = {};
				for (var i = 0; i < cpus.length; i++) {
					if (cpus[i].indexOf('=') == -1) continue;
					var cpu = cpus[i].split('=');
					if (cpu[0] == 'cpu') {
						cpuUsagePie.update(parseFloat(cpu[1]), 100 - parseFloat(cpu[1]));
					} else {
						data[cpu[0]] = parseFloat(cpu[1]);
					}
				}
				cpuUsageLine.update(data);
			} else if (arr[0] == 'mem') {
				var mem = arr[1].split(','),
				used = parseInt(mem[0]),
				free = parseInt(mem[1]);
				memoryUsagePie.update(used, free);
				memoryUsageLine.update({utilization: used / (used + free) * 100});
			} else if (arr[0] == 'net') {
				var ifaces = arr[1].split(';'),
					rx = {}, tx = {};
				for (var i = 0; i < ifaces.length; i++) {
					if (ifaces[i].indexOf('=') == -1) continue;
					var iface = ifaces[i].split('='),
						values = iface[1].split(',');
					rx[iface[0]] = parseFloat(values[0]);
					tx[iface[0]] = parseFloat(values[1]);
				}
				netRxLine.update(rx);
				netTxLine.update(tx);
			} else if (arr[0] == 'disk') {
				var disks = arr[1].split(';'),
					r = {}, w = {};
				for (var i = 0; i < disks.length; i++) {
					if (disks[i].indexOf('=') == -1) continue;
					var disk = disks[i].split('='),
						values = disk[1].split(',');
					r[disk[0]] = 512 * parseFloat(values[0]);
					w[disk[0]] = 512 * parseFloat(values[1]);
				}
				diskRLine.update(r);
				diskWLine.update(w);
			}
		}
	};
	ws.onopen = function(evt) {
		$('#error-message').hide();
	};
	ws.onclose = function (evt) {
		var e = $('#error-message'), w = $(window);
		e.css({
			top: (w.height() - e.height()) / 2,
			left: (w.width() - e.width()) / 2
		}).show();
		setTimeout(connect, 1000);
	};
}
connect();

		</script>
	</body>
</html>

