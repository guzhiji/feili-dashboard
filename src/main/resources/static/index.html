<!DOCTYPE html>
<html>
	<head>
		<meta http-equiv="content-type" content="text/html;charset=utf-8">
		<title>看板</title>
		<link href="/webjars/bootstrap/css/bootstrap.min.css" rel="stylesheet">
		<script src="/webjars/jquery/jquery.min.js"></script>
		<script src="/webjars/sockjs-client/sockjs.min.js"></script>
		<script src="/webjars/stomp-websocket/stomp.min.js"></script>
		<script src="/echarts.min.js"></script>
		<style>
			body {
				background-color: #061325;
				padding: 100px;
			}
		
			.panel-primary>.panel-heading {
				color: #70cac7;
				background-color: #06131b;
			}
		
			.panel-primary>.panel-body {
				background-color: #001531;
			}
		</style>
	</head>
	<body>
		<div class="row">
			<div class="col-md-4">
				<div class="panel panel-primary">
					<div class="panel-heading">
						内存使用率
					</div>
					<div class="panel-body">
						<div id="mu-pie-chart" style="height: 300px;"></div>
					</div>
				</div>
			</div>
			<div class="col-md-8">
				<div class="panel panel-primary">
					<div class="panel-heading">
						内存使用率变化
					</div>
					<div class="panel-body">
						<div id="mu-line-chart" style="height: 300px;"></div>
					</div>
				</div>
			</div>
			<div class="col-md-4">
				<div class="panel panel-primary">
					<div class="panel-heading">
						CPU使用率
					</div>
					<div class="panel-body">
						<div id="cpu-pie-chart" style="height: 300px;"></div>
					</div>
				</div>
			</div>
			<div class="col-md-8">
				<div class="panel panel-primary">
					<div class="panel-heading">
						CPU使用率变化
					</div>
					<div class="panel-body">
						<div id="cpu-line-chart" style="height: 300px;"></div>
					</div>
				</div>
			</div>
			<div class="col-md-6">
				<div class="panel panel-primary">
					<div class="panel-heading">
						网络数据接收速度
					</div>
					<div class="panel-body">
						<div id="netrx-line-chart" style="height: 300px;"></div>
					</div>
				</div>
			</div>
			<div class="col-md-6">
				<div class="panel panel-primary">
					<div class="panel-heading">
						网络数据发送速度
					</div>
					<div class="panel-body">
						<div id="nettx-line-chart" style="height: 300px;"></div>
					</div>
				</div>
			</div>
			<div class="col-md-6">
				<div class="panel panel-primary">
					<div class="panel-heading">
						磁盘使用率
					</div>
					<div class="panel-body">
						<div id="disk-bar-chart" style="height: 300px;"></div>
					</div>
				</div>
			</div>
			<div class="col-md-6">
				<div class="panel panel-primary">
					<div class="panel-heading">
						磁盘活动时间
					</div>
					<div class="panel-body">
						<div id="disktime-line-chart" style="height: 300px;"></div>
					</div>
				</div>
			</div>
			<div class="col-md-6">
				<div class="panel panel-primary">
					<div class="panel-heading">
						磁盘读速度
					</div>
					<div class="panel-body">
						<div id="diskr-line-chart" style="height: 300px;"></div>
					</div>
				</div>
			</div>
			<div class="col-md-6">
				<div class="panel panel-primary">
					<div class="panel-heading">
						磁盘写速度
					</div>
					<div class="panel-body">
						<div id="diskw-line-chart" style="height: 300px;"></div>
					</div>
				</div>
			</div>
		</div>
		<div style="position: fixed; top: 100px; display: none; text-align: center;" id="error-message" class="alert alert-danger">
			服务器连接错误
		</div>
		<script>

var LINECHART_MAX = 100,
	COLOR_ORDER = ['#963c3e','#3b5579', '#4e9845', '#ab9f52', '#729e8a','#749f83', '#ca8622', '#bda29a','#6e7074', '#546570', '#c4ccd3'],
	COLOR_TEXT = '#a5c8e6', COLOR_DARK_LINE = '#395273';

var UtilizationPie = function(id, name, labels) {
	var chart = echarts.init(document.getElementById(id)),
		data = [
			{value: 0, name: labels.used},
			{value: 1, name: labels.free}
		],
		option = {
			color: COLOR_ORDER,
			legend: {
				textStyle: {
					color: COLOR_TEXT
				},
				data: [labels.used, labels.free]
			},
			series: [
				{
					name: name,
					type: 'pie',
					label: {
						show: true,
						color: COLOR_TEXT,
						formatter: '{b}: {d} %'
					},
					itemStyle: {
						opacity: 0.9
					},
					data: data
				}
			]
		};
	// init
	chart.setOption(option);
	return {
		update: function(used, free) {
			data[0].value = used;
			data[1].value = free;
			chart.setOption({
				series: [{data: data}]
			});
		}
	};
};

var UtilizationBar = function(id, labels) {
	var chart = echarts.init(document.getElementById(id)),
		bars = [],
		usedValues = [],
		freeValues = [],
		option = {
			color: COLOR_ORDER,
			animation: false,
			legend: {
				textStyle: {
					color: COLOR_TEXT
				},
				data: [labels.used, labels.free]
			},
			tooltip: {
				show: true,
				formatter: '{b}: {c} %'
			},
			yAxis: {
				splitLine: {
					lineStyle: {
						color: [COLOR_DARK_LINE]
					}
				},
				axisLine: {
					lineStyle: {
						color: COLOR_DARK_LINE
					}
				},
				axisLabel: {
					color: COLOR_TEXT,
					formatter: '{value} %'
				}
			},
			xAxis: {
				splitLine: {
					lineStyle: {
						color: [COLOR_DARK_LINE]
					}
				},
				axisLine: {
					lineStyle: {
						color: COLOR_DARK_LINE
					}
				},
				axisLabel: {
					color: COLOR_TEXT
				},
				data: bars
			},
			series: [
				{
					name: labels.used,
					type: 'bar',
					stack: 'one',
					itemStyle: {
						opacity: 0.9
					},
					data: usedValues
				},
				{
					name: labels.free,
					type: 'bar',
					stack: 'one',
					itemStyle: {
						opacity: 0.9
					},
					data: freeValues
				}
			]
		};
	// init
	chart.setOption(option);
	// export
	return {
		update: function(data) {
			for (var key in data) {
				var p = bars.indexOf(key),
					used = Math.round(data[key] * 100) / 100,
					free = Math.round((100 - data[key]) * 100) / 100;
				if (p == -1) {
					bars.push(key);
					usedValues.push(used);
					freeValues.push(free);
				} else {
					usedValues[p] = used;
					freeValues[p] = free;
				}
			}
			chart.setOption(option);
		}
	};
};

var memoryUsagePie = UtilizationPie('mu-pie-chart', '内存使用率', {
	used: '已用',
	free: '可用'
});
var cpuUsagePie = UtilizationPie('cpu-pie-chart', 'CPU使用率', {
	used: '已用',
	free: '空闲'
});

function sizeFormatter(value) {
	var s = value;
	if (s < 1000) return s + '';
	s /= 1024;
	if (s < 1000) return s.toFixed(1) + ' Kb';
	s /= 1024;
	if (s < 1000) return s.toFixed(1) + ' Mb';
	s /= 1024;
	return s.toFixed(1) + ' Gb';
}

function millisFormatter(value) {
	var s = value;
	if (s < 1000) return s + ' ms';
	s /= 1000;
	if (s < 60) return s.toFixed(1) + ' s';
	s /= 60;
	return s.toFixed(1) + ' min';
}

var TimeLine = function(id, labels, formatter) {
	var chart = echarts.init(document.getElementById(id)),
		yData = [],
		legends = [],
		option = {
			color: COLOR_ORDER,
			animation: false,
			legend: {
				textStyle: {
					color: COLOR_TEXT
				},
				data: legends
			},
			tooltip: {
				trigger: 'axis',
				formatter: function(params) {
					var t = '';
					if (typeof(formatter) == 'function') {
						for (var i = 0; i < params.length; i++) {
							t += params[i].seriesName + ': ' +
								formatter(params[i].value[1]) + '<br>\n';
						}
					} else {
						for (var i = 0; i < params.length; i++) {
							t += params[i].seriesName + ': ' +
								params[i].value[1] + '<br>\n';
						}
					}
					return t;
				}
			},
			xAxis: [
				{
					type: 'time',
					showMinLabel: false,
					showMaxLabel: false,
					splitLine: {
						lineStyle: {
							color: [COLOR_DARK_LINE]
						}
					},
					axisLine: {
						lineStyle: {
							color: COLOR_DARK_LINE
						}
					},
					axisLabel: {
						color: COLOR_TEXT
					}
				}
			],
			yAxis: [
				{
					type: 'value',
					splitLine: {
						lineStyle: {
							color: [COLOR_DARK_LINE]
						}
					},
					axisLine: {
						lineStyle: {
							color: COLOR_DARK_LINE
						}
					},
					axisLabel: {
						color: COLOR_TEXT,
						formatter: formatter
					}
				}
			],
			serise: yData
		};
	// init
	chart.setOption(option);
	// export
	return {
		update: function(t, data) {
			for (var key in data) {
				var legend = key in labels ? labels[key] : key;
				if (legends.indexOf(legend) == -1) {
					legends.push(legend);
					yData.push({
						name: legend,
						type: 'line',
						symbolSize: 2,
						itemStyle: { normal: { areaStyle: { type: 'default' } } },
						data: [[new Date(t), data[key]]]
					});
				} else {
					for (var i = 0; i < yData.length; i++) {
						if (yData[i].name == legend) {
							if (yData[i].data.length >= LINECHART_MAX)
								yData[i].data.shift();
							yData[i].data.push([new Date(t), data[key]]);
							break;
						}
					}
				}
			}

			chart.setOption({
				legend: {data: legends},
				series: yData
			});
		}
	};
};

var memoryUsageLine = TimeLine('mu-line-chart', {
	utilization: '内存使用率'
}, '{value} %');

var cpuUsageLine = TimeLine('cpu-line-chart', {}, '{value} %');

var netRxLine = TimeLine('netrx-line-chart', {}, sizeFormatter);
var netTxLine = TimeLine('nettx-line-chart', {}, sizeFormatter);
var diskBar = UtilizationBar('disk-bar-chart', {
	used: '已用',
	free: '可用'
});
var diskTimeLine = TimeLine('disktime-line-chart', {}, millisFormatter);
var diskRLine = TimeLine('diskr-line-chart', {}, sizeFormatter);
var diskWLine = TimeLine('diskw-line-chart', {}, sizeFormatter);
var ws = null;

function connect() {
	if (window.WebSocket) {
		ws = new WebSocket('ws://localhost:8080/websocket');
	} else {
		ws = new SockJS('/sockjs');
	}
	ws.onmessage = function (evt) {
		var arr = evt.data.split(':');
		if (arr.length) {
			var t = parseInt(arr[1]);
			if (arr[0] == 'cpu') {
				var cpus = arr[2].split(',');
				var data = {};
				for (var i = 0; i < cpus.length; i++) {
					if (cpus[i].indexOf('=') == -1) continue;
					var cpu = cpus[i].split('=');
					if (cpu[0] == 'cpu') {
						cpuUsagePie.update(parseFloat(cpu[1]), 100 - parseFloat(cpu[1]));
					} else {
						data[cpu[0]] = parseFloat(cpu[1]);
					}
				}
				cpuUsageLine.update(t, data);
			} else if (arr[0] == 'mem') {
				var mem = arr[2].split(','),
				used = parseInt(mem[0]),
				free = parseInt(mem[1]);
				memoryUsagePie.update(used, free);
				memoryUsageLine.update(t, {utilization: Math.round(used / (used + free) * 10000) / 100});
			} else if (arr[0] == 'net') {
				var ifaces = arr[2].split(';'),
					rx = {}, tx = {};
				for (var i = 0; i < ifaces.length; i++) {
					if (ifaces[i].indexOf('=') == -1) continue;
					var iface = ifaces[i].split('='),
						values = iface[1].split(',');
					rx[iface[0]] = parseInt(values[0]);
					tx[iface[0]] = parseInt(values[1]);
				}
				netRxLine.update(t, rx);
				netTxLine.update(t, tx);
			} else if (arr[0] == 'diskio') {
				var disks = arr[2].split(';'),
					r = {}, w = {}, dt = {};
				for (var i = 0; i < disks.length; i++) {
					if (disks[i].indexOf('=') == -1) continue;
					var disk = disks[i].split('='),
						values = disk[1].split(',');
					r[disk[0]] = 512 * parseInt(values[0]);
					w[disk[0]] = 512 * parseInt(values[1]);
					dt[disk[0]] = parseInt(values[2]);
				}
				diskRLine.update(t, r);
				diskWLine.update(t, w);
				diskTimeLine.update(t, dt);
			} else if (arr[0] == 'disk') {
				var disks = arr[2].split(';'), d = {};
				for (var i = 0; i < disks.length; i++) {
					if (disks[i].indexOf('=') == -1) continue;
					var disk = disks[i].split('='),
						values = disk[1].split(','),
						used = parseInt(values[0]),
						free = parseInt(values[1]);
					d[disk[0]] = used / (used + free) * 100;
				}
				diskBar.update(d);
			}
		}
	};
	ws.onopen = function(evt) {
		$('#error-message').hide();
	};
	ws.onclose = function (evt) {
		var e = $('#error-message'), w = $(window);
		e.css({
			top: (w.height() - e.height()) / 2,
			left: (w.width() - e.width()) / 2
		}).show();
		setTimeout(connect, 1000);
	};
}
connect();

		</script>
	</body>
</html>

