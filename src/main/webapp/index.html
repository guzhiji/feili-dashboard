<!DOCTYPE html>
<html>
	<head>
		<meta http-equiv="content-type" content="text/html;charset=utf-8">
		<title>看板</title>
		<link href="bootstrap.min.css" rel="stylesheet">
		<script src="jquery.min.js"></script>
		<script src="bootstrap.min.js"></script>
		<script src="echarts.min.js"></script>
	</head>
	<body>
		<div class="container">
			<div class="row">
				<div class="col-md-6">
					<div class="panel panel-primary">
						<div class="panel-heading">
							内存使用率
						</div>
						<div class="panel-body">
							<div id="mu-pie-chart" style="height: 300px;"></div>
						</div>
					</div>
				</div>
				<div class="col-md-6">
					<div class="panel panel-primary">
						<div class="panel-heading">
							内存使用率变化
						</div>
						<div class="panel-body">
							<div id="mu-line-chart" style="height: 300px;"></div>
						</div>
					</div>
				</div>
			</div>
			<div class="row">
				<div class="col-md-6">
					<div class="panel panel-primary">
						<div class="panel-heading">
							CPU使用率
						</div>
						<div class="panel-body">
							<div id="cpu-pie-chart" style="height: 300px;"></div>
						</div>
					</div>
				</div>
				<div class="col-md-6">
					<div class="panel panel-primary">
						<div class="panel-heading">
							CPU使用率变化
						</div>
						<div class="panel-body">
							<div id="cpu-line-chart" style="height: 300px;"></div>
						</div>
					</div>
				</div>
			</div>
			<div class="row">
				<div class="col-md-6">
					<div class="panel panel-primary">
						<div class="panel-heading">
							网络数据接收速度
						</div>
						<div class="panel-body">
							<div id="netrx-line-chart" style="height: 300px;"></div>
						</div>
					</div>
				</div>
				<div class="col-md-6">
					<div class="panel panel-primary">
						<div class="panel-heading">
							网络数据发送速度
						</div>
						<div class="panel-body">
							<div id="nettx-line-chart" style="height: 300px;"></div>
						</div>
					</div>
				</div>
			</div>
			<div class="row">
				<div class="col-md-6">
					<div class="panel panel-primary">
						<div class="panel-heading">
							磁盘读速度
						</div>
						<div class="panel-body">
							<div id="diskr-line-chart" style="height: 300px;"></div>
						</div>
					</div>
				</div>
				<div class="col-md-6">
					<div class="panel panel-primary">
						<div class="panel-heading">
							磁盘写速度
						</div>
						<div class="panel-body">
							<div id="diskw-line-chart" style="height: 300px;"></div>
						</div>
					</div>
				</div>
			</div>
		</div>
		<div style="position: fixed; top: 100px; display: none; text-align: center;" id="error-message" class="alert alert-danger">
			服务器连接错误
		</div>
		<script>

var UtilizationPie = function(id, name, legends) {
	var chart = echarts.init(document.getElementById(id)),
		data = [
			{value: 0, name: legends.used},
			{value: 1, name: legends.free}
		],
		option = {
			legend: {
				data: [legends.used, legends.free]
			},
			series: [
				{
					name: name,
					type: 'pie',
					label: {
						show: true,
						formatter: '{b}: {d} %'
					},
					data: data
				}
			]
		};
	// init
	chart.setOption(option);
	return {
		update: function(used, free) {
			data[0].value = used;
			data[1].value = free;
			chart.setOption({
				series: [{data: data}]
			});
		}
	};
};
var memoryUsagePie = UtilizationPie('mu-pie-chart', '内存使用率', {
	used: '已用',
	free: '可用'
});
var cpuUsagePie = UtilizationPie('cpu-pie-chart', 'CPU使用率', {
	used: '已用',
	free: '空闲'
});

var LINECHART_MAX = 100;

var memoryUsageLine = (function() {

	var muLineChart = echarts.init(document.getElementById('mu-line-chart'));
	var dataTimePoints = [], dataMemUsage = [];
	var muLineChartOption = {
		legend: {
			data: ['内存使用率变化']
		},
		xAxis: [
			{
				type: 'category',
				data: dataTimePoints
			}
		],
		yAxis: [
			{
				type: 'value',
				axisLabel: {
					formatter: '{value} %'
				}
			}
		],
		series: [
			{
				name: '内存使用率变化',
				type: 'line',
				itemStyle: {normal: {areaStyle: {type: 'default'}}},
				data: dataMemUsage
			}
		]
	};

	// init
	muLineChart.setOption(muLineChartOption);

	function update(used, free) {
		if (dataTimePoints.length >= LINECHART_MAX)
			dataTimePoints.shift();
		if (dataMemUsage.length >= LINECHART_MAX)
			dataMemUsage.shift();
		dataTimePoints.push(new Date().toLocaleTimeString());
		// dataTimePoints.push(new Date());
		dataMemUsage.push(used / (used + free) * 100);
		muLineChart.setOption({
			xAxis: [{data: dataTimePoints}],
			series: [{data: dataMemUsage}]
		});
	}

	return {
		update: update
	};

})();

var cpuUsageLine = (function() {

	var cpuLineChart = echarts.init(document.getElementById('cpu-line-chart'));
	var dataTimePoints = [], dataLegends = [], dataCpuUsage = [];
	var cpuLineChartOption = {
		legend: {
			data: dataLegends
		},
		xAxis: [
			{
				type: 'category',
				data: dataTimePoints
			}
		],
		yAxis: [
			{
				type: 'value',
				axisLabel: {
					formatter: '{value} %'
				}
			}
		],
		series: dataCpuUsage
	};

	// init
	cpuLineChart.setOption(cpuLineChartOption);

	function update(data) {

		if (dataTimePoints.length >= LINECHART_MAX)
			dataTimePoints.shift();
		dataTimePoints.push(new Date().toLocaleTimeString());

		for (var cpu in data) {
			if (dataLegends.indexOf(cpu) == -1) {
				dataLegends.push(cpu);
				dataCpuUsage.push({
					name: cpu,
					type: 'line',
					itemStyle: {normal: {areaStyle: {type: 'default'}}},
					data: [data[cpu]]
				});
			} else {
				for (var i = 0; i < dataCpuUsage.length; i++) {
					if (dataCpuUsage[i].name == cpu) {
						if (dataCpuUsage[i].data.length >= LINECHART_MAX)
							dataCpuUsage[i].data.shift();
						dataCpuUsage[i].data.push(data[cpu]);
						break;
					}
				}
			}
		}

		cpuLineChart.setOption({
			legend: {data: dataLegends},
			xAxis: [{data: dataTimePoints}],
			series: dataCpuUsage
		});
	}

	return {
		update: update
	};
})();

var netSpeedLine = function(id) {

	function sizeFormatter(value) {
		var s = value;
		if (s < 1000) return s + '';
		s /= 1024;
		if (s < 1000) return s.toFixed(1) + ' Kb';
		s /= 1024;
		if (s < 1000) return s.toFixed(1) + ' Mb';
		s /= 1024;
		return s.toFixed(1) + ' Gb';
	}

	var netLineChart = echarts.init(document.getElementById(id));
	var dataTimePoints = [], dataLegends = [], dataNet = [];
	var netLineChartOption = {
		legend: {
			data: dataLegends
		},
		xAxis: [
			{
				type: 'category',
				data: dataTimePoints
			}
		],
		yAxis: [
			{
				type: 'value',
				axisLabel: {
					formatter: sizeFormatter
				}
			}
		],
		series: dataNet
	};

	// init
	netLineChart.setOption(netLineChartOption);

	function update(data) {
		if (dataTimePoints.length >= LINECHART_MAX)
			dataTimePoints.shift();
		dataTimePoints.push(new Date().toLocaleTimeString());

		for (var iface in data) {
			if (dataLegends.indexOf(iface) == -1) {
				dataLegends.push(iface);
				dataNet.push({
					name: iface,
					type: 'line',
					itemStyle: {normal: {areaStyle: {type: 'default'}}},
					data: [data[iface]]
				});
			} else {
				for (var i = 0; i < dataNet.length; i++) {
					if (dataNet[i].name == iface) {
						if (dataNet[i].data.length >= LINECHART_MAX)
							dataNet[i].data.shift();
						dataNet[i].data.push(data[iface]);
						break;
					}
				}
			}
		
		}
		netLineChart.setOption({
			legend: {data: dataLegends},
			xAxis: [{data: dataTimePoints}],
			series: dataNet
		});
	}

	return {
		update: update
	};
};
var netRxLine = netSpeedLine('netrx-line-chart');
var netTxLine = netSpeedLine('nettx-line-chart');
var diskRLine = netSpeedLine('diskr-line-chart');
var diskWLine = netSpeedLine('diskw-line-chart');
var ws = null;

function connect() {
	ws = new WebSocket("ws://localhost:8080/feili-dashboard/websocket");
	ws.onmessage = function (evt) {
		var arr = evt.data.split(':');
		if (arr.length) {
			if (arr[0] == 'cpu') {
				var cpus = arr[1].split(',');
				var data = {};
				for (var i = 0; i < cpus.length; i++) {
					if (cpus[i].indexOf('=') == -1) continue;
					var cpu = cpus[i].split('=');
					if (cpu[0] == 'cpu') {
						cpuUsagePie.update(parseFloat(cpu[1]), 100 - parseFloat(cpu[1]));
					} else {
						data[cpu[0]] = parseFloat(cpu[1]);
					}
				}
				cpuUsageLine.update(data);
			} else if (arr[0] == 'mem') {
				var mem = arr[1].split(','),
				used = parseInt(mem[0]),
				free = parseInt(mem[1]);
				memoryUsagePie.update(used, free);
				memoryUsageLine.update(used, free);
			} else if (arr[0] == 'net') {
				var ifaces = arr[1].split(';'),
					rx = {}, tx = {};
				for (var i = 0; i < ifaces.length; i++) {
					if (ifaces[i].indexOf('=') == -1) continue;
					var iface = ifaces[i].split('='),
						values = iface[1].split(',');
					rx[iface[0]] = parseFloat(values[0]);
					tx[iface[0]] = parseFloat(values[1]);
				}
				netRxLine.update(rx);
				netTxLine.update(tx);
			} else if (arr[0] == 'disk') {
				var disks = arr[1].split(';'),
					r = {}, w = {};
				for (var i = 0; i < disks.length; i++) {
					if (disks[i].indexOf('=') == -1) continue;
					var disk = disks[i].split('='),
						values = disk[1].split(',');
					r[disk[0]] = 512 * parseFloat(values[0]);
					w[disk[0]] = 512 * parseFloat(values[1]);
				}
				diskRLine.update(r);
				diskWLine.update(w);
			}
		}
	};
	ws.onopen = function(evt) {
		$('#error-message').hide();
	};
	ws.onclose = function (evt) {
		var e = $('#error-message'), w = $(window);
		e.css({
			top: (w.height() - e.height()) / 2,
			left: (w.width() - e.width()) / 2
		}).show();
		setTimeout(connect, 1000);
	};
}
connect();

		</script>
	</body>
</html>

